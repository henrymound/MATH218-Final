---
title: "KNN and LDA"
author: "Henry Mound"
date: "5/18/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
clinical_spectrum <- read_csv('clinical_spectrum/clinical-spectrum.csv')
```

## Setup
We will be using the clinical spectrum data set for K Nearest Neighbors (KNN) and Linear Discriminant Analysis (LDA) supervised learning. First, we will clean the data. This involves removing all of the NAs and only keeping relevant columns. 
```{r explore}
# Remove all NAs and only keep relevant columns
clinical_spectrum_filtered <- clinical_spectrum[,c(1:39)]
clinical_spectrum_filtered <- clinical_spectrum_filtered[,-c(21, 28)]
clinical_spectrum_clean <- clinical_spectrum_filtered %>%
  na.omit()
# Now, convert test result to colors so we can plot. 
# Red = positive COVID-19 test, Blue = negative
clinical_spectrum_cleanPlot <- clinical_spectrum_clean %>%
  mutate(test_result = ifelse(
    clinical_spectrum_clean$sars_cov_2_exam_result == 'negative',
    'Blue',
    'Red'))

# Let's take a look at how platelet levels and hematocrit effect
# test outcome
plotData <- as.data.frame(
  clinical_spectrum_cleanPlot[, c("test_result", "platelets", "hematocrit")])
plot( plotData[ , c(2, 3) ],
     col=plotData[ ,1 ],
     main = "COVID-19 Test Results by Platelets and Hematocrit")

# How about leukocytes and age?
plotData <- as.data.frame(
  clinical_spectrum_cleanPlot[, c("test_result", "leukocytes", "patient_age_quantile")])
plot( plotData[ , c(2, 3) ],
      col=plotData[ ,1 ],
     main = "COVID-19 Test Results by Leukocytes and Age")

```

These charts show that in general, leukocyte levels, age, platelet count, and hematocrit are all correlated with COVID-19 test results. We tried several different variables, these four showed a promising relationship. In general, as platelet levels, hematocrit, and age increase, the likelihood of a positive test increases. Whereas as leukocyte levels increase, the likelyhood of a positive test decreases. 

But, how do these same four factors effect likelihood of being admitted to the ICU?

```{r explore2}
# Now, convert icu result to colors so we can plot. 
# Red = admitted, Blue = not
clinical_spectrum_cleanPlot <- clinical_spectrum_clean %>%
  mutate(icu_result = ifelse(
    clinical_spectrum_clean$patient_addmited_to_intensive_care_unit_1_yes_0_no == 'FALSE',
    'Blue',
    'Red'))

# Let's check out the save four variables for ICU admittance
plotData <- as.data.frame(
  clinical_spectrum_cleanPlot[, c("icu_result", "platelets", "hematocrit")])
plot( plotData[ , c(2, 3) ],
     col=plotData[ ,1 ],
     main = "ICU Admittance by Platelets and Hematocrit")
plotData <- as.data.frame(
  clinical_spectrum_cleanPlot[, c("icu_result", "leukocytes", "patient_age_quantile")])
plot( plotData[ , c(2, 3) ],
      col=plotData[ ,1 ],
     main = "ICU Admittance by Leukocytes and Age")
```
Unlike test results, these two charts indicate that the four factors have little to do with whether or not the patient was admitted to the hospital as the red and blue dots are relatively evenly spread.


## LDA

Now we will start implementing LDA.
```{r lda}
library(MASS)
# We create a funciton for calculating accuracy from tab results
accuracy <- function(x){sum(diag(x)/(sum(rowSums(x)))) * 100}

# Let's clean up the test results (A = negative, B = positive)
clinical_spectrum_clean <- clinical_spectrum_clean %>%
  mutate(test_result = ifelse(
    clinical_spectrum_clean$sars_cov_2_exam_result == 'negative',
    'A',
    'B'))

# Predicting covid test results from blood
clinical_spectrum_blood <- clinical_spectrum_clean[,c(7:20, 38)]
lda1 <- lda(test_result ~ .,
            data = clinical_spectrum_blood,
            CV = FALSE)
lda1Predict <- predict(lda1,
                       newdata=clinical_spectrum_blood
)
lda1tab <- table(lda1Predict$class, clinical_spectrum_blood$test_result)
accuracy(lda1tab)
```

Linear Discriminant Analysis implemented on this data set with all variables yields an 86.74% accuracy for predicting whether or not a patient has COVID-19. What about ICU rates?

```{r}
# Predicting ICU test results from blood
clinical_spectrum_icu <- clinical_spectrum_clean[,c(6:20)]
ldaICU <- lda(patient_addmited_to_intensive_care_unit_1_yes_0_no ~ .,
            data = clinical_spectrum_icu,
            CV = FALSE)
ldaICUPredict <- predict(ldaICU,
                       newdata=clinical_spectrum_icu
)
ldaICUtab <- table(ldaICUPredict$class, clinical_spectrum_icu$patient_addmited_to_intensive_care_unit_1_yes_0_no)
accuracy(ldaICUtab)
```
Linear Discriminant Analysis for predicting ICU admittance implemented on this data set with all variables yields an 93.92% accuracy. Interesting. Let's plot to see what is going on.

``` {r}
# Now, we will plot
ldaICUPredictions1 <- ldaICUPredict$posterior[,2]
finalICUData1 <- data.frame(clinical_spectrum_icu, ldaICUPredictions1)
finalICUData1 %>%
  ggplot(aes(x = leukocytes,
             y = monocytes)) +
  geom_point(aes(color = ldaICUPredictions1)) + 
  ggtitle("ICU Predictions LDA") +
  xlab("Leukocytes") +
  ylab("Monocytes") +
  labs(color = "Predicted ICU Prob")

ldaTestResultPredictions <- lda1Predict$posterior[,2]
finalICUData2 <- data.frame(clinical_spectrum_icu, ldaTestResultPredictions)
finalICUData2 %>%
  ggplot(aes(x = leukocytes,
             y = monocytes)) +
  geom_point(aes(color = ldaTestResultPredictions)) + 
  ggtitle("Covid Test Result Predictions LDA") +
  xlab("Leukocytes") +
  ylab("Monocytes") +
  labs(color = "Predicted ICU Prob")

```
These graphs show interesting results.The predicted COVID-19 positive test results probability is higher when monocytes are higher and leukocytes are lower (top-left), wheras the predicted ICU probability is higher in the opposite conditions, when leukocyte levels are higher and monocytes are lover (bottom-right).


# Now we will implement KNN
``` {r KNN}
library(class) # For KNN
set.seed(2)
# We will split the data into 75% training, 25% testing
train_ind <- sample(seq_len(nrow(clinical_spectrum_clean[,c(6:20)])),
                    size = floor(0.75 * nrow(clinical_spectrum_clean[,c(6:20)])))
trainICU <- clinical_spectrum_clean[,c(6:20)][train_ind, ]
testICU <- clinical_spectrum_clean[,c(6:20)][-train_ind, ]
# We will predict for ICU admittance first
pred <- knn(train = trainICU, 
            test = testICU, 
            cl = trainICU$patient_addmited_to_intensive_care_unit_1_yes_0_no, 
            k = 1)
tab <- table(pred, testICU$patient_addmited_to_intensive_care_unit_1_yes_0_no)
accuracy(tab)
```
Our KNN implementation yields a 92.31% accuracy on the test data when predicting for ICU admittance, compared to 93.92% using LDA.

Let's try KNN to predict COVID-19 test results. 
```{r}
# KNN for test results
clinical_spectrum_clean <- clinical_spectrum_clean %>%
  mutate(test_result = ifelse(
    clinical_spectrum_clean$sars_cov_2_exam_result == 'negative',
    TRUE,
    FALSE))
train_ind1 <- sample(seq_len(nrow(clinical_spectrum_clean[,c(7:20, 38)])),
                    size = floor(0.75 * nrow(clinical_spectrum_clean[,c(7:20, 38)])))
trainCovid <- clinical_spectrum_clean[,c(7:20, 38)][train_ind1, ]
testCovid <- clinical_spectrum_clean[,c(7:20, 38)][-train_ind1, ]

pred <- knn(train = trainCovid, 
            test = testCovid, 
            cl = trainCovid$test_result, 
            k = 1)
tab1 <- table(pred, testCovid$test_result)
accuracy(tab1)
```
Our KNN implementation yields a 86.81% accuracy on the test data when predicting for ICU admittance, compared to 86.74% using LDA.

In both cases, KNN performs very comparably to LDA.